<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>Анкета</title>

	<script type="text/javascript" src="source/jquery-3.2.1.js"></script>

	<link rel="stylesheet" type="text/css" href="source/css/style.css">
	<link rel="stylesheet" type="text/css" href="source/css/select.css">

	<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Open+Sans" />
</head>

<body>
	<div class="paginat">
		<input type="button" class="button_step_1 step_button_active" value="1" style="color: #000000">
		<input type="button" class="button_step_2" disabled value="2">
		<input type="button" class="button_step_3" disabled value="3">
		<input type="button" class="button_step_4" disabled value="4">
	</div>

	<div class="prev_next">
		<input type="button" class="prev" value="&#12296;  Предыдущий">
		<input type="button" class="next" value="Следующий  &#12297;">
	</div>

	<form id="step_1" class="auth-form" method="post">

		<div class="step_title">1. Введите имя и e-mail</div>

		<input type="text" class="login" placeholder="Имя">
		</br>
		<input type="text" class="email" placeholder="E-mail">
		</br>
	</form>

	<form id="step_2" class="auth-form" method="post">

		<div class="step_title">2. Выберите страну и город</div>

		<ul id="select_countries">
			<li><a id="countries_header">Страна</a>
				<ul style="z-index: 1"></ul>
			</li>
		</ul>
				
		<ul id="select_cities">
			<li><a id="cities_header">Город</a>
				<ul style="z-index: 1"></ul>
			</li>
		</ul>
	</form>

	<script>
		$(document).ready(function () {
			var form_login, form_email;

			// Первый этап
			// Проверка полей на пустоту

			var from_step = 1; // С какого этапа пришли
			var to_step = 1; // На какой этап пришли
			var last_step = 1; // Последний доступный этап
			var max_step = 1; // Тоже последний доступный этап. Нужен для проверок различных частных случаев

			function validLoginEmail() {

				// Проверка логина
				var login = $(".login").val();
				var valid_login = /^[a-zа-яё][a-zа-яё0-9 _-]+$/gi;

				$(".login").removeClass("error_bording_login");
				$(".login").css("border-style", "none");
				$(".error_message_login").remove();

				if (!valid_login.test(login)) {

					if (!$(".login").hasClass("error_bording_login")) {

						if($(".login").val() == 0) {
							$("<span class='error_message_login'> - поле не может быть пустым</span>").insertAfter($(".login"));
						} else {
							$("<span class='error_message_login'> - логин введен некорректно</span>").insertAfter($(".login"));
						}
						$(".login").addClass("error_bording_login");
						$(".login").css("border-style", "solid");
					};

					$(".error_message_login").css("left", 100 + "%");
					$(".error_message_login").css("top", $(".login").position().top + $(".login").outerHeight(true) - $(".login").outerHeight()/2 - $(".error_message_login").outerHeight() / 2);
						form_login = "";
				} else {
					form_login = login;
					$(".login").removeClass("error_bording_login");
					$(".login").css("border-style", "none");
					$(".error_message_login").remove();
				};

				// Проверка e-mail
				var email = $(".email").val();
				var valid_email = /[a-z0-9_\.-]+@[a-z0-9-]+\.[a-z]/gi;

				$(".email").removeClass("error_bording_email");
				$(".email").css("border-style", "none");
				$(".error_message_email").remove();

				if (!valid_email.test(email)) {

					if (!$(".email").hasClass("error_bording_email")) {

						if($(".email").val() == 0) {
							$("<span class='error_message_email'> - поле не может быть пустым</span>").insertAfter($(".email"));
						} else {
							$("<span class='error_message_email'> - email введен некорректно</span>").insertAfter($(".email"));
						}
						$(".email").addClass("error_bording_email");
						$(".email").css("border-style", "solid");
					};

					$(".error_message_email").css("left", 100 + "%");
					$(".error_message_email").css("top", $(".email").position().top + $(".email").outerHeight(true) - $(".email").outerHeight()/2 - $(".error_message_email").outerHeight() / 2);
						form_email = "";
				} else {
					form_email = email;
					$(".email").removeClass("error_bording_email");
					$(".email").css("border-style", "none");
					$(".error_message_email").remove();
				};

				if (form_login && form_email) {
					$("#step_1").css("display", "none");
					$("#step_2").css("display", "inline-block");
					to_step = 2;
				}
			}

			//Второй этап
			var form_country_val = "";	// Для проверки номера страны

			// Получение списка стран
			$.getJSON("data/cities/countries.json", function(data){
				$.each(data, function(val, key) {
					$("#select_countries ul").append("<li><a class='countries_element' data-country="+val+">"+key+"</a></li>");
				});
			});

			// Клик по заголовку списка стран
			$(document).on("click", "#countries_header", function () {

				if ($("#select_countries ul").is(":visible")) {
					$("#select_countries ul").css("display", "none");
				} else {
					$("#select_countries ul").css("display", "block");
					$("#select_cities ul").css("display", "none");
				};

			});

			$(document).on("mouseleave", "#select_countries ul", function () {

				$("#select_cities").css("display", "block");
				$("#select_countries ul").css("display", "none");

			});

			// Клик по названию страны из списка
			$(document).on("click", ".countries_element", function () {

				// Если список городов не пуст - очистить его
				if ($(".cities_element").length > 0) { 
					$(".cities_element").remove();
					$("#cities_header").html("Город");
					$("#cities_header").css("color", "#bbbbbb");
					$("#select_cities ul").css("display", "none");
				};

				form_country_val = $(this).attr("data-country"); // Записали номер страны для загрузки спика нужных городов
				form_country_name = $(this).text(); // Записали название страны для последнего этапа
				$("#countries_header").html(form_country_name);
				$("#countries_header").css("color", "#000000");
				$("#select_countries ul").css("display", "none");
				$("#select_cities").css("display", "block");

				// Получение списка городов
				$.getJSON("data/cities/cities.json", function(data){
					$.each(data, function(val, key) {
						if(key.country == form_country_val) {
							$("#select_cities ul").css("display", "none");
							$("#select_cities ul").append("<li><a class='cities_element' data-cities="+val+">"+key.name+"</a></li>");
						};
					});
				});
			});

			// Клик по заголовку списка городов
			$(document).on("click", "#cities_header", function () {

				if ($("#select_cities ul").is(":visible")) {
					$("#select_cities ul").css("display", "none");
				} else {
					$("#select_cities ul").css("display", "block");
				};
			});

			$(document).on("mouseleave", "#select_cities ul", function () {
				$("#select_cities ul").css("display", "none");
			});

			$(document).on("click", ".cities_element", function () { // Если выбрали город

				form_city_name = $(this).text(); // записали название города для последнего этапа
				$("#cities_header").html(form_city_name);
				$("#cities_header").css("color", "#000000");
				$("#select_cities ul").css("display", "none");
			});




			$(document).on("click", ".next", function () {
				if (to_step == 1) {
					validLoginEmail();
				};
			});

			$(document).on("click", ".prev", function () {
				if (to_step == 2) {
					to_step = 1;
					$("#step_2").css("display", "none");
					$("#step_1").css("display", "inline-block");
				};
			});

		});
	</script>
	
</body>
</html>